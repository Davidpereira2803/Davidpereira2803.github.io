name: Build and Deploy CV

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout CV repo
      uses: actions/checkout@v4

    - name: Compile LaTeX CV (EN)
      uses: xu-cheng/latex-action@v2
      with:
        root_file: cv-llt.tex

    - name: Compile LaTeX CV (FR)
      uses: xu-cheng/latex-action@v2
      with:
        root_file: cv-llt-fr.tex

    - name: Create versioned filenames + info
      shell: bash
      run: |
        set -euo pipefail

        SHORT_SHA="${GITHUB_SHA::7}"
        DATE_UTC="$(date -u +%F)"
        ISO_UTC="$(date -u +%FT%TZ)"

        LATEST_EN="cv-latest.pdf"
        LATEST_FR="cv-latest-fr.pdf"
        VERSIONED_EN="cv-${DATE_UTC}_${SHORT_SHA}.pdf"
        VERSIONED_FR="cv-fr-${DATE_UTC}_${SHORT_SHA}.pdf"

        # outputs from latex-action are cv-llt.pdf and cv-llt-fr.pdf
        mv cv-llt.pdf "$LATEST_EN"
        mv cv-llt-fr.pdf "$LATEST_FR"

        mkdir -p versions
        cp "$LATEST_EN" "versions/$VERSIONED_EN"
        cp "$LATEST_FR" "versions/$VERSIONED_FR"

        cat > cv-info.json <<EOF
        {
          "updated_at_utc": "$ISO_UTC",
          "latest_pdf": "$LATEST_EN",
          "latest_pdf_fr": "$LATEST_FR",
          "versioned_pdf": "versions/$VERSIONED_EN",
          "versioned_pdf_fr": "versions/$VERSIONED_FR"
        }
        EOF

    - name: Push CV files to Portfolio Repo
      uses: cpina/github-action-push-to-another-repository@main
      env:
        API_TOKEN_GITHUB: ${{ secrets.PERSONAL_TOKEN }}
      with:
        source-directory: .
        destination-github-username: Davidpereira2803
        destination-repository-name: Davidpereira2803.github.io
        target-directory: assets/cv
        user-email: github-actions@github.com
        user-name: github-actions
        commit-message: "Auto-update CV (latest + versioned)"
